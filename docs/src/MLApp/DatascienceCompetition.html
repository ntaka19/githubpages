<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>分析用雛形~Classification~(★) &#8212; Home 1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../_static/jupyter-sphinx.css?v=572af1d6" />
    <link rel="stylesheet" type="text/css" href="../../_static/thebelab.css" />
    <script src="../../_static/documentation_options.js?v=29a6c3e3"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/thebelab-helper.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Securities Trade Lifecycle" href="../econ/securitiestradelifecycle/index.html" />
    <link rel="prev" title="Machine Learning System" href="MLSystem.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="classification">
<h1>分析用雛形~Classification~(★)<a class="headerlink" href="#classification" title="Link to this heading">¶</a></h1>
<ul class="simple">
<li><p>いろんな機械学習のアルゴリズムを試したいときに、拡張可能なものを作った。AzureやAWSにもある。ドラッグアンドドロップのものもあるはず。</p></li>
<li><p>システム化を念頭において、デザインパターンをpythonで実装してみた。</p></li>
<li><p>定期的にアップデート予定。(azure モジュール呼び出してみる)</p></li>
</ul>
<p>各セクションへのリンク：</p>
<ol class="arabic simple">
<li><p>パイプライン : <a class="reference internal" href="#frame-pipeline">frame_pipeline</a></p></li>
<li><p>モデル : <a class="reference internal" href="#frame-model">frame_model</a></p></li>
<li><p>実行 : <a class="reference internal" href="#frame-main">frame_main</a></p></li>
</ol>
<section id="pipeline">
<span id="frame-pipeline"></span><h2>Pipeline<a class="headerlink" href="#pipeline" title="Link to this heading">¶</a></h2>
<p>Pipelineを作成するにあたりFactory パターンを利用した。Factory Methodについては下記のようなクラス図がかける。抽象クラスでも作れると思う。</p>
<p class="plantuml">
<img src="../../_images/plantuml-4243403a9a5ff30d82a2839c298c1126e68ed431.png" alt="&#64;startuml

interface IFactory {
    + factoryMethod(): Product
}

interface IProduct {
    + operation(): void
}

class ConcreteFactory {
    + factoryMethod(): Product
}

class ConcreteProduct {
    + operation(): void
}

IFactory -right--&gt; IProduct : create
ConcreteFactory -right--&gt; ConcreteProduct : create

IFactory &lt;|.. ConcreteFactory : implements
IProduct &lt;|.. ConcreteProduct : implements

&#64;enduml"/>
</p>
<p>Interfaceではなくて、抽象クラスだが、ざっくりとした対応関係は次の通り:</p>
<ol class="arabic simple">
<li><p>IFactory → Factory</p></li>
<li><p>ConcreteFactory → PipelineFactory</p></li>
<li><p>IProduct → Pipelineクラス</p></li>
<li><p>ConreteProduct → PipelineLGBなど (pipeline_instances.pyの中のもの)</p></li>
</ol>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">Framework/factory.py</span><a class="headerlink" href="#id2" title="Link to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>

<span class="k">class</span> <span class="nc">Factory</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">ABCMeta</span><span class="p">):</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">create_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Pipeline</span><span class="p">:</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">Pipeline/pipeline_factory.py</span><a class="headerlink" href="#id3" title="Link to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Framework.factory</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">Pipeline.pipeline_instances</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>

<span class="k">class</span> <span class="nc">EPipelineType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">LGB</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">RF</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">LR</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">CB</span> <span class="o">=</span> <span class="mi">4</span>


<span class="k">class</span> <span class="nc">PipelineFactory</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_type</span> <span class="p">:</span> <span class="n">EPipelineType</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span> <span class="n">pipeline_type</span> <span class="o">==</span> <span class="n">EPipelineType</span><span class="o">.</span><span class="n">LGB</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PipelineLGB</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">pipeline_type</span> <span class="o">==</span> <span class="n">EPipelineType</span><span class="o">.</span><span class="n">RF</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PipelineRF</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">pipeline_type</span> <span class="o">==</span> <span class="n">EPipelineType</span><span class="o">.</span><span class="n">LR</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PipelineLR</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">pipeline_type</span> <span class="o">==</span> <span class="n">EPipelineType</span><span class="o">.</span><span class="n">CB</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PipelineCB</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">Pipeline/pipeline_instances.py</span><a class="headerlink" href="#id4" title="Link to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PipelineLGB</span><span class="p">:</span>
<span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">():</span>
    <span class="n">drop_columns</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">&#39;activeclient&#39;</span><span class="p">,</span> <span class="n">ActiveClient</span><span class="p">()),</span>
        <span class="p">(</span><span class="s1">&#39;ToNa&#39;</span><span class="p">,</span> <span class="n">ReplaceWithNa</span><span class="p">()),</span>
        <span class="p">(</span><span class="s1">&#39;binning&#39;</span><span class="p">,</span> <span class="n">Binning</span><span class="p">()),</span>
        <span class="p">(</span><span class="s1">&#39;categorical&#39;</span><span class="p">,</span> <span class="n">Categorical</span><span class="p">()),</span>
        <span class="c1">#(&#39;fillna&#39;, FillNa()),</span>
        <span class="p">(</span><span class="s1">&#39;drop&#39;</span><span class="p">,</span> <span class="n">Drop</span><span class="p">(</span><span class="n">drop_columns</span><span class="p">))</span>
    <span class="p">])</span>

    <span class="k">return</span> <span class="n">pipeline</span>


<span class="k">class</span> <span class="nc">PipelineRF</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">():</span>
        <span class="n">drop_columns</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;drop&#39;</span><span class="p">,</span> <span class="n">Drop</span><span class="p">(</span><span class="n">drop_columns</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">&#39;onehotencoding&#39;</span><span class="p">,</span> <span class="n">OneHotEncode</span><span class="p">(</span><span class="n">one_hot_columns</span><span class="o">=</span><span class="p">[])),</span>
            <span class="p">(</span><span class="s1">&#39;activeclient&#39;</span><span class="p">,</span> <span class="n">ActiveClient</span><span class="p">()),</span>
            <span class="p">(</span><span class="s1">&#39;FillNa&#39;</span><span class="p">,</span> <span class="n">FillNa</span><span class="p">(</span>
                <span class="p">{</span>
                <span class="p">})),</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="n">pipeline</span>

<span class="k">class</span> <span class="nc">PipelineLR</span><span class="p">:</span>
    <span class="c1"># Logistic regression</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">():</span>
        <span class="n">drop_columns</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;drop&#39;</span><span class="p">,</span> <span class="n">Drop</span><span class="p">(</span><span class="n">drop_columns</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">&#39;FillNa&#39;</span><span class="p">,</span> <span class="n">FillNa</span><span class="p">()),</span>
            <span class="p">(</span><span class="s2">&quot;minmax&quot;</span><span class="p">,</span> <span class="n">MinMaxScaler</span><span class="p">()),</span>
            <span class="p">(</span><span class="s1">&#39;standard scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">()),</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="n">pipeline</span>


<span class="k">class</span> <span class="nc">PipelineCB</span><span class="p">:</span>
    <span class="c1"># Catboost</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">():</span>
        <span class="n">drop_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
            <span class="c1">#(&#39;shuffle&#39;, Shuffle()),</span>
            <span class="c1">#(&#39;categorical&#39;, Categorical()),</span>
            <span class="p">(</span><span class="s1">&#39;drop&#39;</span><span class="p">,</span> <span class="n">Drop</span><span class="p">(</span><span class="n">drop_columns</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">&#39;onehotencoding&#39;</span><span class="p">,</span> <span class="n">OneHotEncode</span><span class="p">()),</span>
            <span class="p">(</span><span class="s1">&#39;isnine&#39;</span><span class="p">,</span> <span class="n">ActiveClient</span><span class="p">()),</span>
            <span class="p">(</span><span class="s1">&#39;ToNa&#39;</span><span class="p">,</span> <span class="n">ReplaceWithNa</span><span class="p">()),</span>
            <span class="p">(</span><span class="s1">&#39;FillNa&#39;</span><span class="p">,</span> <span class="n">FillNa</span><span class="p">({})),</span>
            <span class="c1"># (&quot;minmax&quot;, MinMaxScaler()),</span>
            <span class="c1"># (&#39;standard scaler&#39;, StandardScaler()),</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="n">pipeline</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>skPlumberBaseについては下記を参考にした。Pipelineに流せるものはBaseEstimator, TransformerMixinを継承している。(<a class="reference external" href="https://qiita.com/kazetof/items/fcfabfc3d737a8ff8668">https://qiita.com/kazetof/items/fcfabfc3d737a8ff8668</a>)</p></li>
</ul>
</section>
<section id="model">
<span id="frame-model"></span><h2>Model<a class="headerlink" href="#model" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>各種モデルの特徴についてはまたあとでまとめる。</p></li>
<li><p>ModelについてはOptunaでハイパーパラメータチューニングできるように実装してみた。ここのモデルもinterfaceなりabstract classなりでまとめることができる。</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">Models/model.py</span><a class="headerlink" href="#id5" title="Link to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LGBModel</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Created LGB model&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">trials</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
        <span class="n">objective</span> <span class="o">=</span> <span class="n">Objective_LGB</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>

        <span class="n">optuna</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="n">optuna</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
        <span class="n">study</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">create_study</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;maximize&#39;</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">optuna</span><span class="o">.</span><span class="n">samplers</span><span class="o">.</span><span class="n">TPESampler</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">))</span>  <span class="c1"># 最大化</span>
        <span class="n">study</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="n">trials</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">objective</span><span class="o">.</span><span class="n">print_best_callback</span><span class="p">])</span>

        <span class="n">classifier</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="o">**</span><span class="n">study</span><span class="o">.</span><span class="n">best_params</span><span class="p">)</span>
        <span class="n">classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">classifier</span><span class="p">,</span> <span class="n">study</span><span class="o">.</span><span class="n">best_value</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> <span class="n">test_df</span><span class="p">):</span>
        <span class="c1">#classifier = lgb.LGBMClassifier(random_state=seed, **study.best_params)</span>
        <span class="c1">#classifier.fit(x_train, y_train)</span>
        <span class="n">lgb_pred</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span>

        <span class="c1"># 推論</span>
        <span class="c1">#y_test_pred_proba = model.predict(test_df)</span>
        <span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">lgb_pred</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  <span class="c1"># testの予測値を四捨五入し、0,1にする</span>

        <span class="k">return</span> <span class="n">y_test_pred</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">study</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;optuna_lgb_model.pkl&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">study</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">RandomForestModel</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Created Random forest model&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">trials</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
            <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">grid_rf_model</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
            <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">),</span>
            <span class="n">param_grid</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1&#39;</span><span class="p">,</span>
            <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">grid_rf_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">grid_rf_model</span><span class="o">.</span><span class="n">best_estimator_</span><span class="p">,</span> <span class="n">grid_rf_model</span><span class="o">.</span><span class="n">best_score_</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> <span class="n">test_df</span><span class="p">):</span>
        <span class="n">rf_pred</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span>
        <span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">rf_pred</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  <span class="c1"># testの予測値を四捨五入し、0,1にする</span>
        <span class="k">return</span> <span class="n">y_test_pred</span>


<span class="k">class</span> <span class="nc">LogisticRegressionModel</span><span class="p">:</span>
    <span class="c1">#ref https://scikit-learn.org/stable/auto_examples/compose/plot_digits_pipe.html</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Created logistic regression model&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">trials</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
        <span class="n">params</span><span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;pca__n_components&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">columns</span><span class="p">)),</span>
            <span class="s2">&quot;logistic__C&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">logistic</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="n">standard_scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">()</span>
        <span class="n">model_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
            <span class="c1">#(&quot;minmax&quot;, MinMaxScaler()),</span>
            <span class="p">(</span><span class="s1">&#39;standard scaler&#39;</span><span class="p">,</span> <span class="n">standard_scaler</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;pca&quot;</span><span class="p">,</span> <span class="n">pca</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;logistic&quot;</span><span class="p">,</span> <span class="n">logistic</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="n">grid_lr_model</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
            <span class="n">model_pipeline</span><span class="p">,</span>
            <span class="n">param_grid</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1&#39;</span><span class="p">,</span>
            <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">grid_lr_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;best params:&quot;</span><span class="p">,</span> <span class="n">grid_lr_model</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">grid_lr_model</span><span class="o">.</span><span class="n">best_estimator_</span><span class="p">,</span> <span class="n">grid_lr_model</span><span class="o">.</span><span class="n">best_score_</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> <span class="n">test_df</span><span class="p">):</span>
        <span class="c1">#test_df = self.pipe.transform()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;using params...&quot;</span> <span class="p">,</span> <span class="n">classifier</span><span class="o">.</span><span class="n">get_params</span><span class="p">())</span>
        <span class="n">lr_pred</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span>
        <span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">lr_pred</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  <span class="c1"># testの予測値を四捨五入し、0,1にする</span>
        <span class="k">return</span> <span class="n">y_test_pred</span>


<span class="k">class</span> <span class="nc">CatBoostModel</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Created CatBoost model&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">trials</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
        <span class="n">objective</span> <span class="o">=</span> <span class="n">Objective_CatBoost</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>

        <span class="n">optuna</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="n">optuna</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
        <span class="n">study</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">create_study</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;maximize&#39;</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">optuna</span><span class="o">.</span><span class="n">samplers</span><span class="o">.</span><span class="n">TPESampler</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">))</span>  <span class="c1"># 最大化</span>
        <span class="n">study</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="n">trials</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">objective</span><span class="o">.</span><span class="n">print_best_callback</span><span class="p">])</span>

        <span class="n">classifier</span> <span class="o">=</span> <span class="n">CatBoostClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="o">**</span><span class="n">study</span><span class="o">.</span><span class="n">best_params</span><span class="p">)</span>
        <span class="n">classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">classifier</span><span class="p">,</span> <span class="n">study</span><span class="o">.</span><span class="n">best_value</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> <span class="n">test_df</span><span class="p">):</span>
        <span class="n">cb_pred</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span>

        <span class="c1"># 推論</span>
        <span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">cb_pred</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  <span class="c1"># testの予測値を四捨五入し、0,1にする</span>

        <span class="k">return</span> <span class="n">y_test_pred</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">study</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;optuna_catboost_model.pkl&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">study</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="frame-main">
<span id="id1"></span><h2>実行<a class="headerlink" href="#frame-main" title="Link to this heading">¶</a></h2>
<p>実行のイメージ (main)</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">main.py</span><a class="headerlink" href="#id6" title="Link to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

    <span class="n">DIR_PATH</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">OUTPUT_PATH</span><span class="o">=</span><span class="s2">&quot;Output&quot;</span>
    <span class="n">train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">DIR_PATH</span> <span class="o">+</span> <span class="s1">&#39;data/train.csv&#39;</span><span class="p">)</span>  <span class="c1"># train.csvの読み込み</span>
    <span class="n">test_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">DIR_PATH</span> <span class="o">+</span> <span class="s1">&#39;data/test.csv&#39;</span><span class="p">)</span>  <span class="c1"># test.csvの読み込み</span>

    <span class="n">train_df</span> <span class="o">=</span> <span class="n">shuffle</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">LGBModel</span><span class="p">()</span>
    <span class="n">factory</span><span class="p">:</span> <span class="n">Factory</span> <span class="o">=</span> <span class="n">PipelineFactory</span><span class="p">()</span>

    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_pipeline</span><span class="p">(</span><span class="n">EPipelineType</span><span class="o">.</span><span class="n">LGB</span><span class="p">)</span>

    <span class="n">train_pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">&#39;common&#39;</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;xy&#39;</span><span class="p">,</span> <span class="n">SplitXY</span><span class="p">())</span>
    <span class="p">])</span>

    <span class="c1"># 学習モデルの構築 (前処理だけ)</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">train_pipe</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span>

    <span class="c1"># モデルで学習</span>
    <span class="n">best_model</span><span class="p">,</span> <span class="n">best_score</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">trials</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1234</span><span class="p">)</span>

    <span class="c1">#スコアを見てみる</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;best_score: &quot;</span><span class="p">,</span> <span class="n">best_score</span><span class="p">)</span>

        <span class="c1">#結果を出力する</span>
        <span class="n">Util</span><span class="o">.</span><span class="n">write_submit_file</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
        <span class="n">Util</span><span class="o">.</span><span class="n">output_pipeline_diagram</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">)</span>


    <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
        <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Home</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../theme/miscellaneous.html">いろいろ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../theme/morningsatelite.html">モーサテウォッチ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../theme/chatgpt_papers.html">Topic on GPT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../theme/stablediffusion_papers.html">Interesting Papers on Stable Diffusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../theme/zerotoone.html">What important truth do very few people agree with you on?</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../theme/index.html">théma</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mathematics/stochasticcalculus/index.html">Stochastic Calculus</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../kit/2020-03-13-arduino-network-lamp.html">Arduino</a></li>
<li class="toctree-l1"><a class="reference internal" href="../effectivecsharp/index.html">Effective C Sharp #6.0, #7.0 まとめ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../softwareengineering/index.html">Software Engineering(★)</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Machine Learning(★)</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../econ/securitiestradelifecycle/index.html">Securities Trade Lifecycle</a></li>
<li class="toctree-l1"><a class="reference internal" href="../econ/deephedge/index.html">Deep Hedge</a></li>
<li class="toctree-l1"><a class="reference internal" href="../econ/regulations/frtb.html">トレーディング勘定の抜本的見直し（FRTB）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../econ/regulations/benchmarkreform.html">Benchmark Reform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../econ/topic/finance_topic.html">参考サイト</a></li>
<li class="toctree-l1"><a class="reference internal" href="../econ/topic/marketresearch.html">Market Research</a></li>
<li class="toctree-l1"><a class="reference internal" href="../econ/quantlib/index.html">Quantlib (★)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../econ/structuring/index.html">仕組み債</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../neuroscience/index.html">Neuroscience</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Tips/sphinx-tips.html">Sphinx Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../excel/index.html">Excel Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tips/tennis.html">Tennis Tips (★)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tips/todo.html">Todo</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Machine Learning(★)</a><ul>
      <li>Previous: <a href="MLSystem.html" title="previous chapter">Machine Learning System</a></li>
      <li>Next: <a href="../econ/securitiestradelifecycle/index.html" title="next chapter">Securities Trade Lifecycle</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2023, ntaka19.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="../../_sources/src/MLApp/DatascienceCompetition.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>